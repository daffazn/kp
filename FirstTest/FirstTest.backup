#include <DHT.h>
#include <DHT_U.h>
#include <Servo.h>

#include <WiFi.h>
#include <FirebaseESP32.h>

#define FIREBASE_HOST "firsttest-45a5a.firebaseio.com"
#define FIREBASE_AUTH "LEjdDsbYnWn3EwttN7q31jFLPc4fFsRkwBJ8GD4n"
#define WIFI_SSID "La Casa De Papel"
#define WIFI_PASSWORD "2123DuaSatu"

#define DHTPIN 21
#define DHTTYPE DHT11
static const int servoPin = 18;
Servo servo1;

DHT_Unified dht(DHTPIN, DHTTYPE);

FirebaseData firebaseData;

int humData, statusData;
int posDegrees = 0;
int counter = 2;

void setup(){
	Serial.begin(115200);

	//WIFI SETUP///////////////////////////////////////
	WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
	Serial.print("Connecting to Wi-Fi");
	while (WiFi.status() != WL_CONNECTED)
	{
		Serial.print(".");
		delay(300);
	}
	Serial.println();
	Serial.print("Connected with IP: ");
	Serial.println(WiFi.localIP());
	Serial.println();
	
	//SERVER SETUP//////////////////////////////////////
	Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);
	Firebase.reconnectWiFi(true);
	
	
	//SERVO SETUP///////////////////////////////////////
	servo1.attach(servoPin);
	servo1.write(0);
	
	
	//SENSOR SETUP//////////////////////////////////////
	dht.begin();
	sensor_t sensor;
	dht.temperature().getSensor(&sensor);
	dht.humidity().getSensor(&sensor);
}



void loop(){
	//SENSOR/////////////////////////////////////////////////////////
	sensors_event_t event;
	dht.humidity().getEvent(&event);
	humData = event.relative_humidity;
	
	//SEND DATA//////////////////////////////////////////////////////
	if(Firebase.setInt(firebaseData, "/object/Sensor", humData)){
		Serial.print("Sent: ");
		Serial.print(humData);
	}else{
		Serial.print("Send Error: ");
		Serial.println(firebaseData.errorReason());
	}
	
	//RECEIVE DATA///////////////////////////////////////////////////
	if(Firebase.getInt(firebaseData, "/object/Status")){
		Serial.print(" | Received: ");
		statusData = firebaseData.intData();
		Serial.println(statusData);
	}else{
		Serial.print("Receive Error: ");
		Serial.println(firebaseData.errorReason());
	}
	
	//SERVO//////////////////////////////////////////////////////////
	if(statusData == 1){
		if(counter % 2 == 0){
		  posDegrees = posDegrees + 90;
		}else{
      posDegrees = posDegrees - 90;
    }
    servo1.write(posDegrees);
    counter++;
	}

	//DELAY//////////////////////////////////////////////////////////
	delay(500);
}
